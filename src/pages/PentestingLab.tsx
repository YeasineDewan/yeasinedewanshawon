import React, { useState } from 'react';
import { 
  Card, 
  CardHeader, 
  CardBody, 
  Button, 
  Accordion, 
  AccordionItem,
  Chip,
  Progress,
  Tabs,
  Tab,
  Badge,
  Divider,
  Modal,
  ModalContent,
  ModalHeader,
  ModalBody,
  ModalFooter,
  useDisclosure
} from '@heroui/react';
import { Icon } from '@iconify/react';

const vulnerableApps = [
  {
    id: 'xss-playground',
    name: 'XSS Playground',
    description: 'Practice identifying and exploiting Cross-Site Scripting vulnerabilities in a controlled environment.',
    difficulty: 'Beginner',
    category: 'Client-Side',
    duration: '30-45 min',
    tasks: ['Reflected XSS', 'Stored XSS', 'DOM-based XSS'],
    tools: ['Burp Suite', 'Browser DevTools', 'XSS Payloads'],
    progress: 0,
    icon: 'mdi:code-tags',
    status: 'available'
  },
  {
    id: 'sql-injection-lab',
    name: 'SQL Injection Lab',
    description: 'Master the art of SQL Injection detection and exploitation across various database systems.',
    difficulty: 'Intermediate',
    category: 'Server-Side',
    duration: '45-60 min',
    tasks: ['Union-based SQLi', 'Blind SQLi', 'Time-based SQLi'],
    tools: ['SQLMap', 'Burp Suite', 'MySQL/MSSQL'],
    progress: 0,
    icon: 'mdi:database-search',
    status: 'available'
  },
  {
    id: 'csrf-challenge',
    name: 'CSRF Challenge',
    description: 'Understand and exploit Cross-Site Request Forgery vulnerabilities in modern web applications.',
    difficulty: 'Advanced',
    category: 'Web Security',
    duration: '60-90 min',
    tasks: ['CSRF Token Bypass', 'SameSite Bypass', 'Referrer-based Bypass'],
    tools: ['Burp Suite', 'Custom Scripts', 'Browser Extensions'],
    progress: 0,
    icon: 'mdi:shield-lock-outline',
    status: 'available'
  },
  {
    id: 'rce-lab',
    name: 'Remote Code Execution',
    description: 'Learn to identify and exploit RCE vulnerabilities in web applications.',
    difficulty: 'Advanced',
    category: 'Server-Side',
    duration: '90-120 min',
    tasks: ['Command Injection', 'File Upload RCE', 'Deserialization RCE'],
    tools: ['Netcat', 'Burp Suite', 'Reverse Shells'],
    progress: 0,
    icon: 'mdi:terminal',
    status: 'locked'
  },
  {
    id: 'auth-bypass',
    name: 'Authentication Bypass',
    description: 'Explore various authentication bypass techniques and privilege escalation methods.',
    difficulty: 'Intermediate',
    category: 'Web Security',
    duration: '45-60 min',
    tasks: ['JWT Weaknesses', 'Session Hijacking', 'Direct Object References'],
    tools: ['JWT Tool', 'Burp Suite', 'Cookie Editors'],
    progress: 0,
    icon: 'mdi:key',
    status: 'locked'
  },
  {
    id: 'file-inclusion',
    name: 'File Inclusion Lab',
    description: 'Practice LFI and RFI vulnerabilities in different web application scenarios.',
    difficulty: 'Intermediate',
    category: 'Server-Side',
    duration: '30-45 min',
    tasks: ['Local File Inclusion', 'Remote File Inclusion', 'Path Traversal'],
    tools: ['Burp Suite', 'Wordlists', 'LFI Scripts'],
    progress: 0,
    icon: 'mdi:file-document-outline',
    status: 'locked'
  }
];

const learningPaths = [
  {
    name: 'Web Security Fundamentals',
    description: 'Start your journey with essential web security concepts',
    labs: ['xss-playground', 'sql-injection-lab'],
    estimatedTime: '2-3 hours',
    difficulty: 'Beginner'
  },
  {
    name: 'Advanced Web Exploitation',
    description: 'Master complex attack vectors and exploitation techniques',
    labs: ['csrf-challenge', 'auth-bypass', 'file-inclusion'],
    estimatedTime: '4-5 hours',
    difficulty: 'Advanced'
  },
  {
    name: 'Complete Pentester Track',
    description: 'Comprehensive training covering all aspects of web penetration testing',
    labs: ['xss-playground', 'sql-injection-lab', 'csrf-challenge', 'rce-lab', 'auth-bypass', 'file-inclusion'],
    estimatedTime: '8-10 hours',
    difficulty: 'All Levels'
  }
];

const resources = [
  {
    category: 'Documentation',
    items: [
      { name: 'OWASP Top 10', url: '#', description: 'Most critical web application security risks' },
      { name: 'PTES Framework', url: '#', description: 'Penetration Testing Execution Standard' },
      { name: 'NIST Guidelines', url: '#', description: 'National cybersecurity standards and guidelines' }
    ]
  },
  {
    category: 'Tools',
    items: [
      { name: 'Burp Suite', url: '#', description: 'Web application security testing platform' },
      { name: 'OWASP ZAP', url: '#', description: 'Free security analysis tool' },
      { name: 'SQLMap', url: '#', description: 'Automated SQL injection tool' }
    ]
  },
  {
    category: 'Learning Platforms',
    items: [
      { name: 'Hack The Box', url: '#', description: 'Online penetration testing labs' },
      { name: 'TryHackMe', url: '#', description: 'Guided cybersecurity learning' },
      { name: 'PortSwigger Academy', url: '#', description: 'Web security training by Burp Suite creators' }
    ]
  }
];

const PentestingLab: React.FC = () => {
  const [selectedLab, setSelectedLab] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState('labs');
  const [filter, setFilter] = useState('all');
  const { isOpen, onOpen, onOpenChange } = useDisclosure();

  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case 'Beginner': return 'success';
      case 'Intermediate': return 'warning';
      case 'Advanced': return 'danger';
      default: return 'default';
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'available': return 'success';
      case 'locked': return 'default';
      case 'completed': return 'primary';
      default: return 'default';
    }
  };

  const filteredApps = vulnerableApps.filter(app => {
    if (filter === 'all') return true;
    return app.difficulty === filter;
  });

  const handleLabLaunch = (labId: string) => {
    const lab = vulnerableApps.find(app => app.id === labId);
    if (lab?.status === 'available') {
      setSelectedLab(labId);
      onOpen();
    }
  };

  return (
    <div className="container mx-auto px-4 py-8 max-w-7xl">
      {/* Header Section */}
      <div className="text-center mb-12">
        <div className="flex justify-center mb-6">
          <div className="p-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl">
            <Icon icon="mdi:shield-bug" className="text-6xl text-white" />
          </div>
        </div>
        <h1 className="text-5xl font-bold mb-6 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
          Pentesting Lab
        </h1>
        <p className="text-xl text-foreground-600 max-w-3xl mx-auto leading-relaxed">
          Master ethical hacking through hands-on practice in our secure, isolated environment. 
          Build real-world skills with intentionally vulnerable applications designed for learning.
        </p>
        <div className="flex justify-center gap-4 mt-8">
          <Chip color="primary" variant="flat" size="lg" startContent={<Icon icon="mdi:trophy" />}>
            6 Interactive Labs
          </Chip>
          <Chip color="success" variant="flat" size="lg" startContent={<Icon icon="mdi:clock-outline" />}>
            8+ Hours Content
          </Chip>
          <Chip color="warning" variant="flat" size="lg" startContent={<Icon icon="mdi:certificate" />}>
            Skill Certificate
          </Chip>
        </div>
      </div>

      {/* Main Content Tabs */}
      <Tabs selectedKey={activeTab} onSelectionChange={(key) => setActiveTab(key as string)} className="mb-8">
        <Tab key="labs" title="Interactive Labs" />
        <Tab key="paths" title="Learning Paths" />
        <Tab key="resources" title="Resources" />
      </Tabs>

      {/* Labs Tab */}
      {activeTab === 'labs' && (
        <div>
          {/* Filter Section */}
          <div className="flex justify-between items-center mb-8">
            <div className="flex gap-2">
              <Button 
                size="sm" 
                variant={filter === 'all' ? 'solid' : 'flat'}
                color="primary"
                onClick={() => setFilter('all')}
              >
                All Levels
              </Button>
              <Button 
                size="sm" 
                variant={filter === 'Beginner' ? 'solid' : 'flat'}
                color="success"
                onClick={() => setFilter('Beginner')}
              >
                Beginner
              </Button>
              <Button 
                size="sm" 
                variant={filter === 'Intermediate' ? 'solid' : 'flat'}
                color="warning"
                onClick={() => setFilter('Intermediate')}
              >
                Intermediate
              </Button>
              <Button 
                size="sm" 
                variant={filter === 'Advanced' ? 'solid' : 'flat'}
                color="danger"
                onClick={() => setFilter('Advanced')}
              >
                Advanced
              </Button>
            </div>
            <div className="text-sm text-foreground-500">
              {filteredApps.length} labs available
            </div>
          </div>

          {/* Labs Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {filteredApps.map((app) => (
              <Card key={app.id} className="hover:shadow-lg transition-shadow duration-300" isPressable>
                <CardHeader className="pb-2">
                  <div className="flex items-start justify-between w-full">
                    <div className="flex items-center gap-3">
                      <div className="p-2 bg-default-100 rounded-lg">
                        <Icon icon={app.icon} className="text-2xl" />
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold">{app.name}</h3>
                        <div className="flex gap-2 mt-1">
                          <Chip size="sm" color={getDifficultyColor(app.difficulty)} variant="flat">
                            {app.difficulty}
                          </Chip>
                          <Chip size="sm" color="default" variant="flat">
                            {app.category}
                          </Chip>
                        </div>
                      </div>
                    </div>
                    <Badge color={getStatusColor(app.status)} content={app.status === 'locked' ? 'üîí' : ''}>
                      <Icon icon="mdi:chevron-right" className="text-foreground-400" />
                    </Badge>
                  </div>
                </CardHeader>
                <CardBody className="pt-0">
                  <p className="text-foreground-600 text-sm mb-4">{app.description}</p>
                  
                  <div className="space-y-3">
                    <div className="flex items-center gap-4 text-sm text-foreground-500">
                      <div className="flex items-center gap-1">
                        <Icon icon="mdi:clock-outline" className="text-base" />
                        {app.duration}
                      </div>
                      <div className="flex items-center gap-1">
                        <Icon icon="mdi:format-list-checks" className="text-base" />
                        {app.tasks.length} tasks
                      </div>
                    </div>

                    {app.progress > 0 && (
                      <div className="space-y-1">
                        <div className="flex justify-between text-xs">
                          <span>Progress</span>
                          <span>{app.progress}%</span>
                        </div>
                        <Progress value={app.progress} size="sm" color="primary" />
                      </div>
                    )}

                    <Button 
                      color="primary" 
                      variant={app.status === 'available' ? 'solid' : 'flat'}
                      size="sm"
                      className="w-full"
                      isDisabled={app.status === 'locked'}
                      onClick={() => handleLabLaunch(app.id)}
                    >
                      {app.status === 'locked' ? 'Unlock Previous Labs' : 'Start Lab'}
                    </Button>
                  </div>
                </CardBody>
              </Card>
            ))}
          </div>
        </div>
      )}

      {/* Learning Paths Tab */}
      {activeTab === 'paths' && (
        <div className="space-y-6">
          {learningPaths.map((path, index) => (
            <Card key={index} className="hover:shadow-lg transition-shadow">
              <CardHeader>
                <div className="flex justify-between items-start w-full">
                  <div>
                    <h3 className="text-2xl font-bold mb-2">{path.name}</h3>
                    <p className="text-foreground-600">{path.description}</p>
                  </div>
                  <Chip color={getDifficultyColor(path.difficulty)} variant="flat" size="lg">
                    {path.difficulty}
                  </Chip>
                </div>
              </CardHeader>
              <CardBody>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <h4 className="font-semibold mb-3">Included Labs:</h4>
                    <div className="space-y-2">
                      {path.labs.map((labId) => {
                        const lab = vulnerableApps.find(app => app.id === labId);
                        return lab ? (
                          <div key={labId} className="flex items-center gap-2">
                            <Icon icon={lab.icon} className="text-lg" />
                            <span className="text-sm">{lab.name}</span>
                            <Chip size="sm" color={getDifficultyColor(lab.difficulty)} variant="flat">
                              {lab.difficulty}
                            </Chip>
                          </div>
                        ) : null;
                      })}
                    </div>
                  </div>
                  <div className="flex flex-col justify-between">
                    <div className="space-y-2">
                      <div className="flex items-center gap-2">
                        <Icon icon="mdi:clock-outline" className="text-lg" />
                        <span className="text-sm">{path.estimatedTime}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <Icon icon="mdi:school" className="text-lg" />
                        <span className="text-sm">{path.labs.length} labs included</span>
                      </div>
                    </div>
                    <Button color="primary" className="mt-4">
                      Start Path
                    </Button>
                  </div>
                </div>
              </CardBody>
            </Card>
          ))}
        </div>
      )}

      {/* Resources Tab */}
      {activeTab === 'resources' && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {resources.map((category, index) => (
            <Card key={index}>
              <CardHeader>
                <h3 className="text-xl font-semibold">{category.category}</h3>
              </CardHeader>
              <CardBody>
                <div className="space-y-4">
                  {category.items.map((item, itemIndex) => (
                    <div key={itemIndex} className="border-l-2 border-primary-200 pl-4">
                      <a href={item.url} className="block hover:text-primary transition-colors">
                        <h4 className="font-medium text-sm">{item.name}</h4>
                        <p className="text-xs text-foreground-500 mt-1">{item.description}</p>
                      </a>
                    </div>
                  ))}
                </div>
              </CardBody>
            </Card>
          ))}
        </div>
      )}

      {/* Lab Launch Modal */}
      <Modal isOpen={isOpen} onOpenChange={onOpenChange} size="2xl">
        <ModalContent>
          {(onClose) => (
            <>
              <ModalHeader className="flex flex-col gap-1">
                {selectedLab && vulnerableApps.find(app => app.id === selectedLab)?.name}
              </ModalHeader>
              <ModalBody>
                {selectedLab && (() => {
                  const lab = vulnerableApps.find(app => app.id === selectedLab);
                  if (!lab) return null;
                  return (
                    <div className="space-y-4">
                      <p className="text-foreground-600">{lab.description}</p>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <h4 className="font-semibold mb-2">Learning Objectives:</h4>
                          <ul className="space-y-1">
                            {lab.tasks.map((task, index) => (
                              <li key={index} className="flex items-center gap-2 text-sm">
                                <Icon icon="mdi:check-circle" className="text-success" />
                                {task}
                              </li>
                            ))}
                          </ul>
                        </div>
                        
                        <div>
                          <h4 className="font-semibold mb-2">Recommended Tools:</h4>
                          <ul className="space-y-1">
                            {lab.tools.map((tool, index) => (
                              <li key={index} className="flex items-center gap-2 text-sm">
                                <Icon icon="mdi:tools" className="text-warning" />
                                {tool}
                              </li>
                            ))}
                          </ul>
                        </div>
                      </div>
                      
                      <Divider />
                      
                      <div className="bg-warning-50 border border-warning-200 rounded-lg p-4">
                        <h4 className="font-semibold text-warning-800 mb-2">Important Notice:</h4>
                        <p className="text-sm text-warning-700">
                          This lab contains intentional vulnerabilities for educational purposes only. 
                          Only use these techniques on systems you have explicit permission to test.
                        </p>
                      </div>
                    </div>
                  );
                })()}
              </ModalBody>
              <ModalFooter>
                <Button color="default" variant="light" onPress={onClose}>
                  Cancel
                </Button>
                <Button color="primary" onPress={onClose}>
                  Launch Lab Environment
                </Button>
              </ModalFooter>
            </>
          )}
        </ModalContent>
      </Modal>

      {/* Disclaimer Section */}
      <div className="mt-16">
        <Accordion className="px-0">
          <AccordionItem key="disclaimer" aria-label="Disclaimer" title="Important Disclaimer & Ethics">
            <div className="space-y-4">
              <p className="text-foreground-600">
                The vulnerable applications in this lab are for <strong>educational purposes only</strong>. 
                All activities should be conducted within the bounds of ethical hacking principles.
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-success-50 border border-success-200 rounded-lg p-4">
                  <h4 className="font-semibold text-success-800 mb-2">‚úÖ Do:</h4>
                  <ul className="space-y-1 text-sm text-success-700">
                    <li>Practice only in this isolated environment</li>
                    <li>Document your findings and learning progress</li>
                    <li>Share knowledge responsibly</li>
                    <li>Follow responsible disclosure principles</li>
                  </ul>
                </div>
                <div className="bg-danger-50 border border-danger-200 rounded-lg p-4">
                  <h4 className="font-semibold text-danger-800 mb-2">‚ùå Don't:</h4>
                  <ul className="space-y-1 text-sm text-danger-700">
                    <li>Apply techniques to unauthorized systems</li>
                    <li>Share exploit details publicly</li>
                    <li>Use skills for malicious purposes</li>
                    <li>Violate laws or regulations</li>
                  </ul>
                </div>
              </div>
            </div>
          </AccordionItem>
        </Accordion>
      </div>
    </div>
  );
};

export default PentestingLab;